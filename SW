const CACHE_NAME = 'projobalert-cache-v4';  // Version badal diya taaki fresh install ho
const IMAGE_CACHE = 'projobalert-images-v2';
const PAGE_CACHE = 'projobalert-pages-v2';

// ðŸ”¥ Tere 3 images ke exact URLs (tune diye hue)
const IMAGE_URLS = [
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwZRrc_bszbsGph4H05U_ZZBKww4qmbGr_oJK0EEYgsffkcDwa6Mq4OylsW5EVeHTLpUYIxch7VhfFIAiCLA0lP6Ki5bwWxKAJ5v0v96HwTmnNhOgJY6PbnFotvwE5i9qMBbzUuKVfe-0T5JL7TvFOhsAJ4gNO0ZzFovGx7QtE09FT-lG1G0SpLctaHRz2/s320/_Pro%20Job%20Alert%20%20Latest%20Govt%20Jobs%20Updates%20%281%29.webp',
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuhbKCsj1CaI2BHKWaIk02sAQ8p6eDSyHRgvOEcYFUm8cZtrdnrulnhyphenhyphenrsyPtNX3hGArNXHZyLj7sKqFZf_8hXqySkv0j8kdik9ntTknItQfs-dhyphenhyphenYLHgPb4Dyah7SseizgnRzVJTHyNLaV-41v6UAKs-qzJSr_inea2kpW2eLTvbPO0dRv_ALGLLEui_T/s369/Arattai_logo.webp',
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOk8btVJk5mwn-masTpplFHaNb3Fosw9HBYYTHF_A_WGMcUBvFqICyndsnyVs8iOMIavURiy04hHK8c7JHAIASv5FmU6guuPEKeUjGL7LZe1xinrZUSpcvpeMmUGFKMN8yaSl0aid5_oKbSkO_NbMgrccaOv7uR06_lzIeDCJ2_-JyJnbjhnO7-oVdMdYU/s370/Untitled%20design%20%282%29.webp'
];

// Image TTL: 24 hours (yeh change kar â€“ ab fast rahega!)
const IMAGE_MAX_AGE = 24 * 60 * 60 * 1000;

// Page TTL: 1 hour (job updates ke liye safe)
const PAGE_MAX_AGE = 1 * 60 * 60 * 1000;

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(IMAGE_CACHE)
      .then(cache => cache.addAll(IMAGE_URLS))
      .then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', event => {
  const cachesToKeep = [CACHE_NAME, IMAGE_CACHE, PAGE_CACHE];
  event.waitUntil(
    caches.keys().then(keyList =>
      Promise.all(keyList.map(key => {
        if (!cachesToKeep.includes(key)) return caches.delete(key);
      }))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', event => {
  const url = new URL(event.request.url);

  // 1. Images ke liye: Cache first + normalize URL (s320/s369 ignore)
  if (url.pathname.includes('blogger.googleusercontent.com') && url.pathname.match(/\.(webp|jpg|png|gif|svg)$/i)) {
    // Normalize URL: size parameter hata do taaki cache hit ho
    const normalizedUrl = url.origin + url.pathname;
    event.respondWith(
      caches.open(IMAGE_CACHE).then(cache => {
        return cache.match(normalizedUrl).then(cached => {
          if (cached) {
            const cachedTime = new Date(cached.headers.get('date') || 0).getTime();
            if (Date.now() - cachedTime < IMAGE_MAX_AGE) return cached;
          }
          return fetch(event.request).then(response => {
            if (response && response.status === 200) {
              const copy = response.clone();
              copy.headers.set('date', new Date().toUTCString());
              cache.put(normalizedUrl, copy);
            }
            return response;
          }).catch(() => cached);
        });
      })
    );
    return;
  }

  // 2. Pages/Posts ke liye: Stale-while-revalidate (instant cache, background update)
  if (url.origin === location.origin && (url.pathname === '/' || url.pathname.endsWith('.html'))) {
    event.respondWith(
      caches.open(PAGE_CACHE).then(cache => {
        return cache.match(event.request).then(cached => {
          const fetchPromise = fetch(event.request).then(response => {
            if (response && response.status === 200) {
              const copy = response.clone();
              const headers = new Headers(copy.headers);
              headers.set('sw-cache-time', Date.now());
              const cachedRes = new Response(copy.body, { status: copy.status, headers });
              cache.put(event.request, cachedRes);
            }
            return response;
          }).catch(() => cached);

          if (cached) {
            const cachedTime = new Date(cached.headers.get('sw-cache-time') || 0).getTime();
            if (Date.now() - cachedTime < PAGE_MAX_AGE) {
              event.waitUntil(fetchPromise);  // Background update
              return cached;
            }
          }
          return fetchPromise;
        });
      })
    );
    return;
  }

  // Baaki requests normal
  event.respondWith(fetch(event.request));
});
