const CACHE_VERSION = 'projobalert-v5';  // Update karte time badal dena
const IMAGE_CACHE = 'projobalert-images-v3';
const PAGE_CACHE = 'projobalert-pages-v3';

// ðŸ”¥ Tere 4 images ke URLs yahan daal (jitne bhi hain)
const IMPORTANT_IMAGE_URLS = [
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwZRrc_bszbsGph4H05U_ZZBKww4qmbGr_oJK0EEYgsffkcDwa6Mq4OylsW5EVeHTLpUYIxch7VhfFIAiCLA0lP6Ki5bwWxKAJ5v0v96HwTmnNhOgJY6PbnFotvwE5i9qMBbzUuKVfe-0T5JL7TvFOhsAJ4gNO0ZzFovGx7QtE09FT-lG1G0SpLctaHRz2/s320/_Pro%20Job%20Alert%20%20Latest%20Govt%20Jobs%20Updates%20%281%29.webp',
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhuhbKCsj1CaI2BHKWaIk02sAQ8p6eDSyHRgvOEcYFUm8cZtrdnrulnhyphenhyphenrsyPtNX3hGArNXHZyLj7sKqFZf_8hXqySkv0j8kdik9ntTknItQfs-dhyphenhyphenYLHgPb4Dyah7SseizgnRzVJTHyNLaV-41v6UAKs-qzJSr_inea2kpW2eLTvbPO0dRv_ALGLLEui_T/s369/Arattai_logo.webp',
  'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOk8btVJk5mwn-masTpplFHaNb3Fosw9HBYYTHF_A_WGMcUBvFqICyndsnyVs8iOMIavURiy04hHK8c7JHAIASv5FmU6guuPEKeUjGL7LZe1xinrZUSpcvpeMmUGFKMN8yaSl0aid5_oKbSkO_NbMgrccaOv7uR06_lzIeDCJ2_-JyJnbjhnO7-oVdMdYU/s370/Untitled%20design%20%282%29.webp'
  // 4th image add kar dena yahan
];

// Images ka TTL (long term â€“ 7 days = 604800000 ms, change kar sakta hai)
const IMAGE_MAX_AGE = 7 * 24 * 60 * 60 * 1000;  // 7 days â€“ kam/jyada kar lo

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(IMAGE_CACHE)
      .then(cache => cache.addAll(IMPORTANT_IMAGE_URLS))
      .then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', event => {
  const cachesToKeep = [CACHE_VERSION, IMAGE_CACHE, PAGE_CACHE];
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.map(key => {
        if (!cachesToKeep.includes(key)) return caches.delete(key);
      })
    )).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', event => {
  const url = new URL(event.request.url);

  // 1. All Blogger images (thumbnails bhi) â€“ aggressive long cache + normalize URL
  if (url.hostname.includes('blogger.googleusercontent.com') && url.pathname.match(/\.(webp|jpg|jpeg|png|gif|svg)$/i)) {
    const normalizedKey = url.origin + url.pathname.split('/s')[0] + url.pathname.substring(url.pathname.lastIndexOf('/')); // size ignore
    event.respondWith(
      caches.open(IMAGE_CACHE).then(cache => {
        return cache.match(normalizedKey).then(cached => {
          if (cached) {
            const age = Date.now() - (new Date(cached.headers.get('date') || 0).getTime());
            if (age < IMAGE_MAX_AGE) return cached;
          }
          return fetch(event.request).then(response => {
            if (response.ok) {
              const copy = response.clone();
              copy.headers.set('date', new Date().toUTCString());
              cache.put(normalizedKey, copy);
            }
            return response;
          }).catch(() => cached || fetch(event.request));
        });
      })
    );
    return;
  }

  // 2. Pages & Posts â€“ True Stale-While-Revalidate (instant cached + silent background fresh)
  if (url.origin === self.location.origin && (url.pathname === '/' || url.pathname.endsWith('.html') || url.pathname.includes('/search'))) {
    event.respondWith(
      caches.open(PAGE_CACHE).then(cache => {
        return cache.match(event.request).then(cachedResponse => {
          // Always fetch fresh in background
          const fetchPromise = fetch(event.request).then(networkResponse => {
            if (networkResponse && networkResponse.status === 200) {
              const copy = networkResponse.clone();
              cache.put(event.request, copy);
            }
            return networkResponse;
          });

          // Agar cache hai toh instant serve karo + background update
          if (cachedResponse) {
            event.waitUntil(fetchPromise);  // Silent background update
            return cachedResponse;
          }

          // Naya page â€“ network se lao aur cache mein daalo
          return fetchPromise;
        });
      })
    );
    return;
  }

  // Baaki sab normal
  event.respondWith(fetch(event.request));
});
